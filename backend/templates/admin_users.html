{% extends "admin_base.html" %}

{% block title %}Registered Users{% endblock %}

{% block content %}
<h2 class="mb-4">Registered Users</h2>

<table class="table table-striped table-bordered" id="usersTable">
    <thead class="table-primary">
        <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Full Name</th>
            <th>Address</th>
            <th>Pin Code</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Populated by JS -->
    </tbody>
</table>

<!-- Edit Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editUserForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editUserId">
          <div class="mb-2">
            <label for="editFullname" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="editFullname" required>
          </div>
          <div class="mb-2">
            <label for="editAddress" class="form-label">Address</label>
            <input type="text" class="form-control" id="editAddress">
          </div>
          <div class="mb-2">
            <label for="editPincode" class="form-label">Pincode</label>
            <input type="text" class="form-control" id="editPincode">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
fetch('/api/users')
  .then(res => res.json())
  .then(users => {
    const tbody = document.querySelector('#usersTable tbody');
    users.forEach(user => {
      const row = `
        <tr>
          <td>${user.id}</td>
          <td>${user.email}</td>
          <td>${user.fullname}</td>
          <td>${user.address || '-'}</td>
          <td>${user.pincode || '-'}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="openEditModal(${user.id}, '${user.fullname}', '${user.address || ''}', '${user.pincode || ''}')">âœï¸ Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">ğŸ—‘ï¸ Delete</button>
          </td>
        </tr>`;
      tbody.innerHTML += row;
    });
  });

function openEditModal(id, fullname, address, pincode) {
  document.getElementById('editUserId').value = id;
  document.getElementById('editFullname').value = fullname;
  document.getElementById('editAddress').value = address;
  document.getElementById('editPincode').value = pincode;
  new bootstrap.Modal(document.getElementById('editUserModal')).show();
}

document.getElementById('editUserForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const id = document.getElementById('editUserId').value;
  const fullname = document.getElementById('editFullname').value.trim();
  const address = document.getElementById('editAddress').value.trim();
  const pincode = document.getElementById('editPincode').value.trim();

  const res = await fetch(`/admin/update_user/${id}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ fullname, address, pincode })
  });

  if (res.ok) {
    alert('âœ… User updated successfully!');
    location.reload();
  } else {
    const data = await res.json();
    alert(`âŒ Error: ${data.error}`);
  }
});

function deleteUser(id) {
  if (confirm('Are you sure you want to delete this user?')) {
    fetch(`/admin/delete_user/${id}`, {
      method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
      if (data.message) {
        alert('âœ… User deleted');
        location.reload();
      } else {
        alert('âŒ Failed to delete user');
      }
    });
  }
}
</script>
{% endblock %}
